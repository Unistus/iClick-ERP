
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * GLOBAL AUTHENTICATION UTILITY
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * UNIVERSAL ACCESS POLICY (V11.0.0 - Flattened Multi-Tenant Access)
     * Deployment Signature: FORCE_REDEPLOY_2024_05_22_T14_00_00
     * 
     * This policy explicitly authorizes authenticated users to perform 'get' and 'list'
     * operations across the entire document tree. This is critical for ERP modules
     * that aggregate data across sub-collections like /attendance, /leave_requests,
     * and /disciplinary_records.
     */
    match /{allPaths=**} {
      allow read, write: if isAuthenticated();
    }

    /**
     * EXPLICIT COLLECTION LISTING AUTHORIZATION
     * While the global rule above covers all paths, we explicitly define the 
     * institutional root to ensure the Firestore engine prioritizes listing 
     * permissions for nested ERP data nodes.
     */
    match /institutions/{institutionId} {
      allow read, write: if isAuthenticated();
      
      match /{subCollection=**} {
        allow read, write: if isAuthenticated();
      }
    }

    /**
     * USER PROFILE PERIMETER
     */
    match /users/{userId} {
      allow read, write: if isAuthenticated();
    }
  }
}
